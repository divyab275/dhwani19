<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Group</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.10.0/firebase.js"></script>
<script>
        axios.get('https://api.github.com/users/codeheaven-io');
</script>
<script src= "./static/js/commonscript.js"></script>
<script>

firebase.initializeApp(config);
var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = window.location.search.substring(1),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
        }
    }
    
};
var gid = getUrlParameter('gid');


function SignIn(provider){  
    firebase.auth().signInWithPopup(provider)
    .then(function(result) {
        var token = result.credential.accessToken;
        console.log(token)
        var user = result.user;
        firebase.auth().currentUser.getIdToken(/* forceRefresh */ true).then(function(idToken) {
        localStorage.setItem("accessToken",idToken);
        var config = {
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'x-auth-token': localStorage.accessToken
            }
        };
        localStorage.setItem("user",user.uid);
        user_data={}
        user_data.uid = localStorage.user
        user_data.groupid = gid
        console.log(user_data)
        axios.post(server_url+'/group/reunion/name',user_data)
        .then(res=>{
                console.log(res.data.length)
                if(false){
                    //User member of the group
                    console.log(window.location.search.substring(1))
                    $('#join').hide()
                    document.getElementById('Link').innerHTML =  window.location.href;
                }
                else{
                    // User not member of the group
                    console.log(localStorage.accessToken)
                   axios.post(server_url+"/student/login",{idToken:localStorage.accessToken})
                   .then(resp=>{
                       console.log("User added");
                      // console.log(user)
                       
                   })
                   .catch(e=>{
                       console.log("User not added")
                   })
                   
                }
                   
            })
        }).catch(function(error) {
            console.log("Error in accessing token")
        });
        
    })
    .catch(err=>{
        console.log("Sign In problems")
    })
}

function join(){
    if(localStorage.user){
        //User signed in
        axios.get(server_url+'/public/student/'+localStorage.user)
        .then(res=>{
            console.log("Inside then of /public/student")
            console.log(res)
            if(res.data.collegeId){
                //College details filled
                console.log("College details filled")
                axios.post(server_url+'/group/reunion/name',user_data)
                .then(res=>{
                    console.log(res)
                    if(res.data.length!=0){
                        //User member of the group
                        console.log("User member of the group")
                        $('#join').hide()
                        document.getElementById('Link').innerHTML = window.location.href;
                    }
                    else{
                        //User not member of the group
                        console.log("User not member of  group")
                        var info={}
                        info.groupid = gid;
                        info.uid = localStorage.user
                        console.log(info)
                        axios.post(server_url+'/group/reunion/addStudentReunion',info)
                        .then(res=>{
                            console.log("Student successfully added to reunion grp");
                            window.location.reload()
                        }) 
                        .catch(err=>{
                            console.log("Student not added to reunion grp")
                        })
                    }
                    
                })
                .catch(err=>{
                    console.log("Error")
                })    
            }
            else{
                //College details not filled
                console.log("College details not filled")
                modal.style.display = "block";

            }
        })
        .catch(err=>{
            console.log("error in /public/student")
        })
        
    }
    else{
        // User not signed in
        alert('Please sign in first')
    }
}

function registerStudent(){
    firebase.auth().currentUser.getIdToken(/* forceRefresh */ true).then(function(idToken) {
        localStorage.setItem("accessToken",idToken);
    var config = {
            headers: {
                'Content-Type': 'application/json',
                'x-auth-token': localStorage.accessToken
            }
    };
    var clg = document.getElementById('college').value
    var phone = document.getElementById('phoneNumber').value
    console.log(clg)
    console.log(phone)
    axios.put(server_url+'/public/college',{name:clg})
        .then(res=>{
            console.log('/public/college done successfully')
            console.log(res)
            var info = {}
            info.phone = phone
            info.collegeId = res.data.id
            // info.uid = localStorage.user
            console.log(info)
            console.log(config)
            axios.post(server_url+"/student/register",{phone:phone,collegeId:res.data.id},config)
            .then(result=>{
                console.log(result)
                var post_info={}
                post_info.groupid=gid;
                post_info.uid = localStorage.user
                console.log(post_info)
                axios.post(server_url+'/group/reunion/addStudentReunion',post_info)
                .then(resp=>{
                    console.log(resp)
                window.location.reload();
                })
                .catch(er=>{
                    console.log("Error in /group/reunion")
                })
            })
            .catch(error=>{
                console.log("Error in /student/register")
            })
           
        })
        .catch(err=>{
            console.log('error in /public/college')
        })
    }).catch(function(error) {
        console.log("Error in accessing token")
    });

  
    // console.log(phone);
    // console.log(clg)
}

function createInput(){
        console.log("Inside create input")
        var $input = $('<input type="button" value="Join" onclick="join()"/>');
        $input.appendTo($("#join"));
        var $comment = $('<p>If not signed up , do it here</p>');
        $comment.appendTo($("#join"))
        var $signin = $('<input type="button" value="Sign Up" onclick="googleSignIn()"/>');
        $signin.appendTo($("#join"));
    }
  
</script>
<body>
    <div id="gname"></div>
    <div id="gdescription"></div>
    <div id="groupMembers"></div>
    <div id="join"></div>
    <div id="signin"></div>
    <div id="Link"></div>
    <!-- <button id="myBtn">Open Modal</button> -->

        <!-- The Modal -->
        <div id="myModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <span class="close">&times;</span>
            <div>college name<input type="text" id="college"></div>
            <div>Phone Number<input type="text" id="phoneNumber"></div>
            <div id = "regButton"><button onclick="registerStudent()">OK</button></div>
        </div>

        </div>
</body>
<script>
initApp = function check() {
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            user.getIdToken().then(function(accessToken) {
            // User is signed in.
            var req_body={}
            req_body.uid = localStorage.user
            req_body.groupid = gid
          
            })
            .catch(err=>{
                console.log("Error")
            })
        }
        else{
            //User not signed in
            $('#Link').hide();
            createInput();
        }
    });
}

function  onload(){
    var gid = getUrlParameter('gid');
    axios.get(server_url+'/group/reunion/'+gid)
    .then(res=>{
        console.log(res)
        document.getElementById('gname').innerHTML = "Group Name  : "+res.data[0].name;
        document.getElementById('gdescription').innerHTML ="Group Description : "+ res.data[0].description;
        axios.post(server_url+'/group/reunion/studentDetails',{gid:gid})
        .then(resul=>{
            console.log(resul)
            for (let index = 0; index < resul.data.length; index++) {
                const element = resul.data[index];
                console.log(element.name)
                $('#groupMembers').append('<p>'+element.name+'</p>')
            }
           console.log("Reached here")
            if(localStorage.accessToken){
                console.log("User signed in");
                user_data={}
                user_data.uid = localStorage.user
                user_data.groupid = gid
                axios.post(server_url+'/group/reunion/name',user_data)
                .then(res=>{
                    console.log(res)
                    if(res.data.length!=0){
                        //User member of the group
                        console.log(window.location.search.substring(1))
                        document.getElementById('Link').innerHTML =  window.location.href;
                    }
                    else{
                        //User not member of the group
                        createInput();
                    }
                 })
                .catch(er=>{

                })
            }
            else{
                console.log("User not signed in");
                createInput();
            }
        })
        .catch()
      

    })
    .catch(err=>{
        document.getElementById('gname').innerHTML = "err"
    })

    
}


window.addEventListener('load', function() {
    // firebase.initializeApp(config);
   onload()
});
</script>
<style>
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content/Box */
.modal-content {
  background-color: #fefefe;
  margin: 15% auto; /* 15% from the top and centered */
  padding: 20px;
  border: 1px solid #888;
  width: 30%; /* Could be more or less, depending on screen size */
}

/* The Close Button */
.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}
</style>
<script>
var modal = document.getElementById('myModal');

// Get the button that opens the modal
// var btn = document.getElementById("myBtn");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks on the button, open the modal
// btn.onclick = function() {
//   modal.style.display = "block";
// }

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
} 
</script>
</html>